<div id="tagSearch">
  <form onsubmit="return false;">
    <input id="tagSearchInput" type="text"
      onfocus="tagSearchFocus(); return false;"
      oninput="tagSearchInputHandler( this.value ); return false;"
      placeholder="태그 검색"
      autocomplete=off
      style="
          vertical-align: middle;" />
  </form>
  <div class="result">
    <div class="msg _fontSmaller"></div>
    <div class="tagBoxBox">
      <div class="searchResult">
        <div class="tagBox-alpha"><!-- 가나다순; 검색어 시작 부분 일치 항목들만 표시. --></div>
        <hr>
        <div class="tagBox-contains"><!-- 검색어 시작 외 부분 일치 항목만 인기순 표시. -->
          <div><!-- tagcloud1 --></div>
          <div><!-- tagcloud2 --></div>
          <div><!-- tagcloud3 --></div>
          <div><!-- tagcloud4 --></div>
          <div><!-- tagcloud5 --></div>
        </div>
      </div>
      <h5 class="areaTitle">인기태그</h5>
      <div class="tagBox-pop"><!-- 인기태그만 검색어 관계없이 노출. --></div>
    </div>
  </div>
  <a class="toTagPage _fontSmaller" href="/tag">전체 태그 보러가기</a>
</div><script>
  const tagSearch = document.getElementById('tagSearch');
  const tagSearch_result = tagSearch.getElementsByClassName('result')[0];
  const tagSearch_msg    = tagSearch.getElementsByClassName('msg')[0];
  const tagBox_alpha     = tagSearch.getElementsByClassName('tagBox-alpha')[0];
  const tagBox_contains  = tagSearch.getElementsByClassName('tagBox-contains')[0];
  const tagBox_pop       = tagSearch.getElementsByClassName('tagBox-pop')[0];
  let tagAList = [];// a 태그들 (미부착)
  let tagSearch_timer = null;
  let tagSearch_fetched = false;

  function tagSearchFocus(){
    if( tagSearch_fetched ) return;

    tagSearch_msg.textContent = '태그 목록 불러오는 중.';
    fetch( T.config.DEFAULT_URL + '/tag', {
      method: 'GET'
    }).then(response => {
      if (!response.ok) throw new Error('HTTP error ' + response.status);
      return response.text();// HTML 텍스트
    }).then(htmlText => {
      const tagDoc = (new DOMParser()).parseFromString( htmlText, 'text/html' );// HTML 텍스트 → DOM
      const tagBox = tagDoc.getElementById('tagBox');
      if( tagBox == null ){
        throw new Error('불러온 문서에 tagBox 없음.');
      }
      tagAList = Array.from( tagBox.getElementsByTagName('a') );
      const tagBox_pop = tagSearch.getElementsByClassName('tagBox-pop')[0];

      for( let tagA of tagAList ){
        tagA = document.adoptNode( tagA );
        if( tagA.classList.contains('tagcloud1')
         || tagA.classList.contains('tagcloud2')
         || tagA.classList.contains('tagcloud3') ){
          tagBox_pop.appendChild( tagA.cloneNode(true) );
        }
      }

      tagAList.sort((a, b) => a.textContent.localeCompare( b.textContent, 'ko' ));

      tagSearch_fetched = true;
      tagSearch_result.classList.add('fetched');
      tagSearch_search(
        document.getElementById('tagSearchInput').value
      );// 기다리는 동안 벌써 검색어를 입력했을 수도 있으니까 함 실행해줘야지.
    }).catch(error => {
      console.error(error);
      tagSearch_msg.textContent = '태그 목록 불러오기 실패';
    });
  }

  function tagSearchInputHandler( searchword ){
    searchword = searchword.trim();
    if( tagSearch_timer != null ) clearTimeout( tagSearch_timer );// 즉각 동작 안 하고 0.1초 뜸.(빠른 타자 기다림)

    tagSearch_timer = setTimeout( tagSearch_search, 100, searchword );
  }

  function tagSearch_search( searchword ){
    //// tagBox-alpha 에 전체 태그 있다. 검색어에 따라 클래스로 노출 여부 조작.
    //// tagBox-alpha 에 미해당 항목들 중 tagBox-contains 해당 것들을 복사하여 넣음.

    //// 초기화
    tagBox_alpha.innerHTML = '';
    for( let tagBox_contains_n of tagBox_contains.children ){
      tagBox_contains_n.innerHTML = '';
    }

    if( searchword === '' ){
      tagSearch_msg.textContent = `전체 태그 ${tagAList.length}개`;
      return;
    }

    searchword = searchword.toLowerCase();
    let count = 0;
    for( let tagA of tagAList ){
      const tagText = tagA.textContent.toLowerCase();
      if( tagText.includes( searchword ) ){
        count += 1;
        const clone = tagA.cloneNode(true);
        clone.innerHTML = clone.innerHTML.toLowerCase()
          .replace( searchword, `<span class="match">${searchword}</span>` );// 검색어 일치 부분 강조
        if( tagText.startsWith( searchword ) ){// 검색어 시작부분 일치
          tagBox_alpha.appendChild( clone );
        }
        // 그밖에 검색어 포함
        else if( clone.classList.contains('tagcloud1') )
          tagBox_contains.children[0].appendChild( clone );
        else if( clone.classList.contains('tagcloud2') )
          tagBox_contains.children[1].appendChild( clone );
        else if( clone.classList.contains('tagcloud3') )
          tagBox_contains.children[2].appendChild( clone );
        else if( clone.classList.contains('tagcloud4') )
          tagBox_contains.children[3].appendChild( clone );
        else if( clone.classList.contains('tagcloud5') )
          tagBox_contains.children[4].appendChild( clone );
      }
    }
    if( count > 0){
      tagSearch_msg.textContent = `검색된 태그 ${count}개`;
    }else{
      tagSearch_msg.textContent = '그 부분을 포함한 태그가 없습니다.';
    }
  }
</script>